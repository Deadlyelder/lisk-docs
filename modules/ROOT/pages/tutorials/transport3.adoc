= Transport Tutorial Part 3: Next steps
:toc:
:imagesdir: ../../assets/images
:experimental:
:v_core: master
:sectnums: 3
:sectnumlevels: 3

== Make it portable

Currently the packet is not actually portable, as it requires a power source which is established by a USB connection to the computer.

Firstly, to ensure portability can be achieved an independent power source is required, such as a battery that can provide the Raspberry Pi with adequate power, to enable the packet to be tracked.

Secondly, it is necessary for the tracking script to be automatically enabled after the the Raspberry Pi boot process has been executed.

This can easily be achieved on the Raspberry Pi by installing `pm2` globally as shown below:

[source,bash]
----
npm install pm2 -g
pm2 startup
----

This should print the applicable command in the terminal window.
Copy it and paste it in the terminal again to complete the setup of the `pm2` startup script.

Start the tracking script with `pm2`.

.Run the following command inside the `light_alarm` folder on the Raspberry Pi.
[source,bash]
----
pm2 start --name lightAlarm index.js
----

.Add the tracking script to the list of processes, that will be started automatically when the Raspberry pi is started.
[source,bash]
----
pm2 save
----

After this has been performed, log out from the Raspberry Pi, disconnect it from the computer, and connect it to an external portable power source.
After the boot process has completed, (approximately 1-2 minutes), then the tracking script will start running, which in turn will check the light sensor every second.

== Connect more nodes

During development it is both necessary and convenient to have a rather centralized network with only one node connected.

Once the development has reached the point of concept or a usable product stage, it will be necessary to add more nodes to the network, and hence offer other potential users the opportunity to join the newly created blockchain network.

This is how the setup should look like after completing part 2. xref:tutorials/transport2.adoc[Part 2: A simple supply chain tracking system]:

image:1-node.png[One node diagram]

The next step is to add one more node to the network that communicates between the seed node, the IoT and the client app as shown below:

image:2-nodes.png[More nodes diagram]

=== Set up an additional seed node

When setting up a new node, each new node will firstly connect to the seed nodes when booting for the first time.
Starting from the seed node, a new node will discover the rest of the network by requesting their peer list; followed by the peer lists of the newly discovered peers and so on.

The seed node is a node that is specified in the config of the node application under `modules.network.seedPeers` and this should remain connected to the network.

Furthermore, it is also convenient to have the genesis delegates actively forging on the seed node, in case the network does not yet have enough real delegates who can take the forging spots.

TIP: The exposed `configDevnet` object is a good template for the config of a seed node, as it already includes the credentials from all of the 101 genesis delegates and automatically enables forging for all of them.

=== Create a new config suited for the node application

Exchange the `configDevnet` object that was passed to the node during the development with the customized version.

[TIP]
====
It's recommended to create a config object with all the options that are different to the default config options.
To check the default config options, go to the xref:configuration.adoc[configuration page] or check it directly in the code listed below: +
`lisk-framework/src/modules/MODULE_NAME/defaults/config.js`. +
The same for the components as shown below: +
`lisk-framework/src/components/COMPONENT_NAME/defaults/config.js`.
====

Most of the configurations can stay the same to what is defined in the default config options.
However, please note that there is one option that should be updated: **The seed node(s)**.

So to add `1.2.3.4` as a seed node, add an object (or several objects) with the 2 properties `ip` and `wsPort` to the `seedPeers` list as displayed below:

[source,js]
----
configDevnet.modules.network.seedPeers = [{ ip: '1.2.3.4', wsPort: 5000}]
----

[NOTE]
====
By default, the forging delegates list is empty. +
This is intended, as the genesis delegates are only needed to set up a working dev environment.
Subsequently it is recommended that the `delegates` list is empty, so that the users can input their own credentials in the case whereby they wish to activate forging on their node.

For example, for a proof of concept, in order to provide the already activated forging delegates inside the config; please use the devnet genesis delegates in https://github.com/LiskHQ/lisk-sdk/blob/development/sdk/src/samples/config_devnet.json[configDevnet] or create your own genesis delegates and add them to the config.
====

=== Publish the application

Add the code for the customized `node` application (including the custom transaction types), to a public code repository.
For example, on  https://github.com/[Github] or https://about.gitlab.com/[Gitlab].

This provides everyone the opportunity to download the application and deploy it on a server in order to connect with the network.

The code should include at least the following files listed below:

* `index.js` : The code that initializes and starts the node application.
* `package.json` : A project file that lists all needed dependencies, (this should include `lisk-sdk` as a dependency).
* `transactions/` : A folder containing all required custom transaction types.
* `README` : A Readme file which describes the most important steps to setup the node.

=== Connect nodes and verify

Add a second node to the network.

This new node will not have any forging activated, it is only required to talk via the API with the `client` app, and over the websocket connection to the seed node.
Therefore, at present the seed node is the only node at this point that can forge new blocks.
This is due to the fact that all the genesis delegates are actively forging on it.

TIP: How to replace the genesis delegates with real delegates is covered in the next section <<_3_replace_dummy_delegates_with_real_ones, Replace dummy delegates with real ones>>.

To set up the node, just install the published application on a new server.

IMPORTANT: Do not forget to open the corresponding xref:configuration.adoc#_ports[ports] for HTTP and WS communication!

.Snippet of client/app.js
[source,js]
----
// Constants
const API_BASEURL = 'http://134.209.234.204:4000'; <1>
const PORT = 3000;
----

<1> Add the correct IP and port here to the newly added node.

.Logs of the newly added node:
image:synching_node.png[Synching non forging node]

In the logs shown above it can be seen that the seed node was already 3 blocks ahead when the second node was started.
It first synchronizes the missing blocks up to the current height and then broadcasts the received transactions from the client app to the seed node, whereby the delegates can then add the transactions to blocks and forge them.

These new blocks are broadcasted again to the new node, and the client app can display the data based on the API calls that it sends to the new node.

.Log of the seed node with the forging genesis delegates:
image:forging_node.png[Forging node logs]

[NOTE]
.Please be aware that broadcast errors can occur.
====
Sometimes errors occur when broadcasting transactions between the nodes.
There is no cause for concern here, as the node will re-start the sync process again; and in the majority of cases it is successful on the next attempt.
====

image:common-sync-issue.png[Common sync issue]

In the above image the block at height 284 is not accepted because of an invalid block timestamp.
As a result, also the following blocks are also discarded by the node.

Anomalies like this can occur within the network.
The node can usually resolve these issues on its own by starting a new sync process, whereby it requests the missing blocks from one of its' peer nodes.

As shown in the logs above, the blocks at height 284, 285 and 286 are displayed as discarded.
At this point the node realizes it is not in sync with the other nodes and starts the sync process.
This can also be seen in the above logs, `Starting sync`.
During the sync process the missing blocks are received from the peers and added to the database of the node.

== Replace the dummy delegates with real ones

During development of the Lisk Transport application, one node was enabled for forging for all 101 genesis delegates.

After the release of the first version of the blockchain application, it is necessary that real delegates take the forging slots of the genesis delegates.
The network will become stable and decentralized for the first time when at least 51 real delegates are actively forging in the network.

To join the network as a new delegate, follow the steps listed below:

. xref:lisk-commander/user-guide/commands.adoc#_create_account[Create your own,private account on the network].
. xref:lisk-commander/user-guide/commands.adoc#_delegate_registration_transaction[Register a delegate].
. Set up a node: Follow the steps in the `README` file of the app, (Alternatively read the Lisk tutorials, as this process is basically identical).
. xref:{v_core}@lisk-core::configuration.adoc#_enabledisable_forging[Enable forging for the newly created delegate on the node].
. People become convinced to vote for a delegate in the network, if the delegate has the following attributes:
** Is helpful.
** Is reachable.
** Is trustworthy.
** Is accountable.
** Is sharing rewards.
** Is offering useful services or tools.

image:3-nodes.png[3 nodes diagram]

[NOTE]
====
It depends on the distribution of vote power, who to convince.

If a delegate joins the network on a very early stage, he or she will probably replace one of the genesis delegates.
The genesis delegates are voted in by the genesis account which holds all the tokens on the initial network start.
The genesis account votes with these tokens for the genesis delegates, in order to stabilize the network during the development.

Therefore, when replacing a genesis delegate, the new delegate will need to convince the person who controls the genesis account of the network; which will be most likely the app developer.

Later, when the majority of the existing tokens are distributed among the different private accounts, the new delegate needs to gain the trust of the community in order to be voted into a forging position.
====

== Write unit tests for custom transactions

How to test `undoAsset` functions.

== Task: Add more sensors

Connect more sensors to secure the travel of the packet.
For example, implement a `TemperatureAlarm` or `HumidityAlarm`  to the `LightAlarm` transaction type.

== Task: Add other improvements such as GPS tracking or estimated travel times
