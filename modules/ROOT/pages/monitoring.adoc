= Monitoring
Mona Bärenfänger <mona@lightcurve.io>
:toc:

== Log Monitoring

The xref:configuration.adoc#_file_log_stream[log files] provide a chronological list of activities that occurred on a node.
These activities can be analyzed further to provide monitoring for a particular node or the network in general.
As the logs are created in JSON format, it is possible to pipe the log messages to additional monitoring software.
The node operator can then filter automatically for certain events, and visualize them through a frontend application.
In addition, it can also be used to send notifications to the operator in case of an emergency.

Various types of monitoring software packages currently exist that support log analysis.
For example: https://www.elastic.co/products/kibana/[Kibana], https://grafana.com/[Grafana] or https://www.graylog.org/[Graylog].

== Performance Monitoring

For performance monitoring http://newrelic.com/[New Relic] is used to monitor the activities inside of the application.
It provides a detailed insight into the system and keeps track of all activity performance.
For example, an HTTP API call or a background process from Lisk Core jobs queue.

IMPORTANT: Please note that New Relic is only supported for versions below 3.0


The following steps should provide the insights of why and how to monitor your Lisk Core node using the New Relic tool.

=== Enable New Relic

==== Get New Relic license key

Firsly it is required to register an account at https://rpm.newrelic.com.
After the login has ben initiated, select ``Account settings'' in the account drop down list in the New Relic UI.
From the Account information section on the right side of the Summary page, copy your license key.

==== Add the license key

[tabs]
====
Option 1 - As environment variable::
+
--
To enable the performance monitoring on your node, ensure the environment variable `NEW_RELIC_LICENSE_KEY` is set as shown below:

*Binary and Source*

[source,bash]
----
export NEW_RELIC_LICENSE_KEY=XXXXXXXXX
----

*Docker*

[source,bash]
----
cd lisk_repo/docker <1>
----

<1> Navigate into the `docker` directory.

Inside, edit `docker-compose.override.yml` and add the license key as shown below:

....
version: "3"
services:

  lisk:
    environment:
      - NEW_RELIC_LICENSE_KEY=XXXXXXXXX
....

Then, save your changes to the file and reinitialize Docker so it can use the new environment variable.

[source,bash]
----
docker-compose up -d <1>
----

<1> (Re)start docker containers.
--
Option 2 - In newrelic.js::
+
--
The second method of adding the license key is to edit `newrelic.js` file which can be found in the root directory of the Lisk Core installation.

[source,bash]
----
cd lisk_repo <1>
----

<1> Open the root folder of Lisk Core.

<2> Locate and open the file `newrelic.js` and search for the option `license_key`.

<3> Add the license key as a string value as shown below:

....
/**
 * Your New Relic license key.
 *
 * MUST set the license key using `NEW_RELIC_LICENSE_KEY` env variable
 * if you wish to enable monitoring of the lisk node
 */
license_key: 'XXXXXXXXX',
....

After the license key has been added, save the changes and reload your node.
--
====

==== (Re)start Lisk Core node

Start the node in the usual manner as shown below:

[source,bash]
----
bash lisk.sh start <1>
npx pm2 start lisk <2>
docker start container_id <3>
----

<1> Start lisk core binary.
<2> Start lisk core source.
<3> Start lisk core docker.

Alternatively, restart the node if it is already running as shown below:

[source,bash]
----
bash lisk.sh reload <1>
npx pm2 restart lisk <2>
docker restart container_id <3>
----

<1> Restart lisk core binary.
<2> Restart lisk core source.
<3> Restart lisk core docker.

=== Keep your node busy

To monitor activities in the system it is required perform various actions, such as taking a snapshot, syncing your node, or running various API request against it.
New Relic can also monitor internal activities of the system e.g. different queue jobs.

Various processes can be performed to create workload on your node, and these are described below:

==== Option 1: Lisk Core Test Suite

NOTE: The Lisk Core Test Suite is only available for Lisk Core from Source.

NOTE: The `+unit+` Testsuite is not suited for this purpose, as unit tests are not executed in the context of the running application.

The README file of the Lisk Core repository in Github describes the following: https://github.com/LiskHQ/lisk-core#tests[how to run the Testsuite].

==== Option 2: Apache Bench

https://httpd.apache.org/docs/2.4/programs/ab.html[Apache Bench] is a generic benchmarking tool designed to measure the performance of HTTP servers.

It is recommended to perform the following request as shown below:

[source,bash]
----
now && ab -n 200000 -c 1 -k "http://127.0.0.1:7000/api/accounts?publicKey=4e8896e20375b16e5f1a6e980a4ed0cdcb3356e99e965e923804593669c87ad2"
----

After executing the above commands, append the current system time on top of the Apache Bench output.
In case it may be required to compare the New Relic benchmark results with the Apache Bench output, then it is recommended to add the current system time in order to ascertain exactly when the benchmark started, as the Apache Bench does not log this information.

`-n`: The number of requests that are executed.

`-c`: The number of requests to perform in parallel.

`-k`: Enable the HTTP KeepAlive feature.
For example, perform multiple requests within one HTTP session.

==== Option 3: Siege

https://www.joedog.org/siege-manual[Siege] is another tool for benchmarking the performance of HTTP servers.

Using Siege, it is recommended to perform the following request:

[source,bash]
----
siege -c 10 -t 30m http://127.0.0.1:7000/api/blocks
----

`-c`: Number of requests to perform in parallel.

`-t`: Allows the test to run for a selected period.

==== Option 4: Custom script

It is also possible to create your own custom scripts, and specify the order and amount of actions for the node to perform during the analysis, dependant on a specific use case or scenario that may be required to benchmark.

=== Analysis with New Relic

An example case study is described here.
An analysis of the performance of API `GET /api/transactions` endpoint is required in order to ascertain the following data:

. If any bottlenecks are occurring at the database level.
. Which of the database queries are taking the longest time.

The following steps below are then required:

[source,bash]
----
$ cd ~/lisk_repo
~/lisk_repo $ export NEW_RELIC_LICENSE_KEY=xxxxxxxxxxx
~/lisk_repo $ npx pm2 start lisk
----

Using Siege the following command is then executed to perform the requests:

[source,bash]
----
siege -c 10 -t 5m http://127.0.0.1:4000/api/transactions
----

This script will automatically continue sending the HTTP requests against the node for 5 minutes (`-t 5m`).
During that time please be aware of the following points:

. You may wish to disable the cache on the node to obtain the real performance analysis.
To perform this, set the `+cacheEnabled+` in configuration to `false`.
. It may not be possible to view the viable results if the development blockchain dataset is empty.
This could be changed by running the tests against the Testnet data.
. It may take a few minutes before the analyzed results are visible in the New Relic interface.

To see the New Relic instrumentation results, please log in to https://rpm.newrelic.com, and select `APM` from the top menu.

The first screen is the list of applications.
Depending on which network your node is running in, the application title can be seen as shown in the illustration below.

image:app_dashboard.png[Apps List UI]

Please select the specific application by clicking its name.
The dashboard in the following illustration below will be seen:

image:dashboard.png[Dashboard UI]

In order to acquire a more in depth knowledge of this dashboard, please read the following: https://learn.newrelic.com/courses/intro_apm.
In this specific example only the HTTP requests were executed against the node (`GET /api/transactions`), hence, there is only one section displaying the results.
Select "Transactions" from the left menu in the above screen.
Please see the detailed instructions in the illustration below.

NOTE: For clarification, the New Relic transactions have no relation with Lisk transactions.
It is only the grouping term that New Relic use to show analytics.

image:transactions.png[Transactions UI]

In the illustration above the most valuable information is highlighted in the rectangle, which provides the following information:

. The majority of the time (56%) was spent in ExpressJS which is a Node.js module.
. During this experiment, one database view (`trs_list`) and one database table (`delegates`) were involved in the persistence layer.
. Querying to database table `delegates` was fast.
. The query to a database view `trs_list` was quite expensive.
. On average API calls for `GET /api/transactions` took 122ms.

If this information is required in a tabular form for a presentation, please click on the "Show all transactions table" link.
This will result in the view shown in the following illustration below:

image:transactions_data.png[Transactions Data]

From this screen it is possible to see the following:

. In the selected time range a total of 14252 requests were performed to `GET /api/transactions`.
. The slowest request took 2.17 seconds.
. The fastest request took 10ms.
. The average time for requests is 122ms while the standard deviation is 213ms.
. Difference between average and standard deviation shows there were small spikes between requests.
. It is possible to export data to CSV format from this screen to maintain a record or share with others.

If it is required to debug in depth which transactions actually took 2.17 seconds, please go back to the previous screen, scroll down and the transaction traces will be visible as shown in the illustration below:

image:trace_list.png[Trace list]

Here you can see an overview of an individual transaction which took longer time and is considered as "slow".
The threshold which defines the "slow" transactions is configured in file `newrelic.js` under `transaction_tracer.explain_threshold`, which is currently 100ms.
Every request which took more than 100ms will be considered as "slow" and logged as the trace by New Relic.
Let’s debug further and verify what made this request "slow", by clicking on any of the trace links in the list.

image:trace_summary.png[Trace summary]

As shown on the above trace summary, most of the transaction’s time was spent in two functions `modules.transactions.shared.getTransactions` and `Middleware: bound logClientConnections`.
You can go to trace detail to see more information and call stack.
You can also click on "Database queries" to see which queries were executed during this request.

It’s also possible to find the database query which is taking most of the time.
To do this, please click on the left side menu for "Database" and then sort by "Most time consuming" and then select the top of the list.

image:database_query.png[Database Queries]

Scroll down on the page shown above, you will see the slow queries shown below:

image:slow_queries.png[Slow Queries]

By analyzing the above diagrams, we can conclude the following assuming that all stats are strictly within experiment time range:

. The slowest queries in the system are queries for `trs_list` view.
. For that database view `trs_list` the slowest query is the `SELECT count(*) FROM trs_list` which took 2.13 seconds.
. There are few other queries in the on `trs_list` view which took more than 1 second time.
. If you click on the top slow query, you will notice the query was executed during `GET /api/transactions`.

image:query_detail.png[Query Detail]

We hope the above use case helps you to understand the usage and benefits of New Relic.
Please let us know if you want to know more.

=== FAQ

*I am not seeing Lisk Data in the New Relic APM dashboard?*

Please make sure to check following.

. Are you using a valid license key to your account?
. Have you exported the license key on the node where you are running Lisk?
. Have you selected the proper time range in New Relic APM?
. Are you looking on the right page? E.g. you may be searching web transactions but you had selected Non-Web transactions in UI.
. If you just run the node, give it a few minutes let New Relic crunch the data and show in UI.

*Are the performance measures consistent?*

. As far as you are using the same machine specification to run different scenarios, the stats will be consistent.
. We recommend to not benchmark on your development machine, as it can have another workload during different test runs.
. If you are using AB or Siege, always use the same number of connections to simulate the same request load on a node.

*How is it useful for me as a Delegate or Exchange?*

. Performance of the machine may affect the behavior of interacting with the node.
. You can create alert policies on New Relic to inform you when your app taking more memory.
. You can set alerts to see if the database is getting slow.
. You can track if some errors occurred in the system, which were not handled properly.
